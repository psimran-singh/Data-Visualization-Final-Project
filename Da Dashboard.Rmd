---
title: "Solar Adoption in New Jersey"
output: 
  flexdashboard::flex_dashboard:
    theme: default
    orientation: rows
    source_code: "https://github.com/psimran-singh/Data-Visualization-Final-Project"
    vertical_layout: fill
runtime: shiny

---
```{r global, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(shiny)
library(plotly)
library(formattable)
library(DT)
library(lubridate)
library(xts)
library(dygraphs)
library(nivocal)
library(sf)
library(RColorBrewer)
library(leaflet)
library(htmltools)

<<<<<<< Updated upstream
=======
# Load in all the necessary data tables:
>>>>>>> Stashed changes
setwd("~/Data Viz in R/Data-Visualization-Final-Project/Data Files for Analysis")

## Section 1: Overall Landscape ##
# Load in all the data we need
load("Solar_All_County.Rda")
load("Solar_Res_County.Rda")
county_level_rates <- read_csv('County_Totals.csv')
county_level_sectors <- read_csv('County_Sectors.csv')
Solar_All_County <- st_as_sf(Solar_All_County) %>% st_transform(4326)
Solar_Res_County <- st_as_sf(Solar_Res_County) %>% st_transform(4326)


## Section 2: Overall Trends ## 
# Load in all the data we need
trend <- read_csv('Trend.csv')
trend_trans <- read_csv('Trend_Transposed.csv')
trend_yoy <- read_csv('Trend_Percents.csv')

## Section 3: Analysis ##
# Load in all the data we need
zip_level_res <- read_csv("Residential_Solar_Zip.csv")
income_trend <- read_csv("Trendline For Income.csv")
own_trend <- read_csv("Trendline For House Ownership.csv")
val_trend <- read_csv("Trendline For Housing Value.csv")
white_trend <- read_csv("Trendline For White Population.csv")

```

Overall Landscape
=====================================

Current Landscape {.sidebar}
-----------------------------------------------------------------------

Pick a county to highlight below:

```{r}
selectInput("County", "County:", choices = distinct(county_level_rates, `County`))
```

Row
-----------------------------------------------------------------------

### Current Installed Solar Capacity

```{r}
renderValueBox({
  total_cap <- paste(prettyNum(county_level_rates[county_level_rates$County==input$County,4],big.mark=",",digits=0)," MW")
  valueBox(total_cap, 
           icon = "fa-sun",
           color = "#FD8D3C")
})
```

### Current Installed Solar Projects

```{r}
renderValueBox({
  total_quant <- paste(prettyNum(county_level_rates[county_level_rates$County==input$County,2], big.mark=","))
  valueBox(total_quant,
           icon = "fa-solar-panel",
           color = "#74C476")
})
```

Row
-----------------------------------------------------------------------
### Total Capacity by County

```{r}
renderLeaflet(
  {Solar_All_County0 <- Solar_All_County %>%
    mutate(selected = ifelse(County == input$County, TRUE, FALSE))
    
  pal1 <- colorBin(palette = "Oranges", domain = Solar_All_County$capacity_mw)
  labs1 <- as.list(paste(Solar_All_County$County,round(Solar_All_County$capacity_mw)," MW"))
  
  map1 <- leaflet(options = leafletOptions(zoomControl = FALSE,
                                             dragging = FALSE,
                                             minZoom = 7.3,
                                             maxZoom = 7.3)) %>%
  addPolygons(data = Solar_All_County,
              label = lapply(labs1, HTML), # hover label
              color = "grey", # the color of the border
              fillColor = ~pal1(Solar_All_County$capacity_mw), # the colors inside the polygons
              weight = 1.0, # the thickness of the border lines
              opacity = 1.0, # the transparency of the border lines
              fillOpacity = 1.0) %>%
  addLegend(data = Solar_All_County, # the dataset
            "bottomright", # where to put the legend
            pal = pal1, values = ~capacity_mw, # specify the color palette and the range of values 
            title = "Capacity (MW)", # legend title
            opacity = 1.0) 
  # %>%
  # addPolygons(data = Solar_All_County0[Solar_All_County0$selected==TRUE],
  #             color="yellow",
  #             weight=1.5,
  #             fillOpacity=0)

    map1}
)
```

### Total Quantity by County

```{r}
renderLeaflet(
  {pal2 <- colorBin(palette = "Greens", domain = Solar_All_County$quantity, 6)
  labs2 <- as.list(paste(Solar_All_County$County,
                         prettyNum(Solar_All_County$quantity,big.mark=",",digits=1)))
  
  
  map2 <- leaflet(options = leafletOptions(zoomControl = FALSE,
                                             dragging = FALSE,
                                             minZoom = 7.3,
                                             maxZoom = 7.3)) %>%
  addPolygons(data = Solar_All_County,
              label = lapply(labs2,HTML), # hover label
              color = "grey", # the color of the border
              fillColor = ~pal2(Solar_All_County$quantity), # the colors inside the polygons
              weight = 1.0, # the thickness of the border lines
              opacity = 1.0, # the transparency of the border lines
              fillOpacity = 1.0) %>%
  addLegend(data = Solar_All_County, # the dataset
            "bottomright", # where to put the legend
            pal = pal2, values = ~quantity, # specify the color palette and the range of values 
            title = "# of Projects", # legend title
            opacity = 1.0) # the transparency of the legend

    map2}
)
```

Row {.tabset}
-----------------------------------------------------------------------

### Capacity by County and Sector

```{r}
renderPlotly(
  {county_level_sectors0 <- county_level_sectors %>% filter(County != "Overall") %>%
    mutate(selected = ifelse(County == input$County, TRUE, FALSE))
  
  colors <- county_level_sectors0 %>% select(County,selected) %>% 
    mutate(res_color = ifelse(selected == TRUE, "#6367CE", "#9FA3F2")) %>%
    mutate(nonres_color = ifelse(selected == TRUE, "#F1A73E", "#F7C57D")) %>%
    mutate(gs_color = ifelse(selected == TRUE, "#4DBA37", "#89EA76"))

fig <- plot_ly(county_level_sectors0, 
               x = county_level_sectors0$`County`, 
               y = (county_level_sectors0$`cap_res`/1000),
               type = "bar", 
               name = "Residential",
               marker = list(color = colors$res_color))  %>%
  add_trace(y = (county_level_sectors0$`cap_nonres`/1000),
            name = 'Non-Residential',
            marker = list(color = colors$nonres_color))  %>%
  add_trace(y = (county_level_sectors0$`cap_gs`/1000),
            name = 'Grid Supply',
            marker = list(color = colors$gs_color))  %>%
  layout(yaxis = list(title = "Capacity (MW)"), 
         xaxis = list(title = "Year",
                      tickangle = -45,
                      tickmode = 'linear', 
                      categoryorder = "total descending"),
         hovermode='x',
         barmode = "stack")
  fig}
)

```

### Quantity by County and Sector

```{r}
renderPlotly(
  {county_level_sectors0 <- county_level_sectors %>% filter(County != "Overall") %>%
    mutate(selected = ifelse(County == input$County, TRUE, FALSE))
  
  colors <- county_level_sectors0 %>% select(County,selected) %>% 
    mutate(res_color = ifelse(selected == TRUE, "#6367CE", "#9FA3F2")) %>%
    mutate(nonres_color = ifelse(selected == TRUE, "#F1A73E", "#F7C57D")) %>%
    mutate(gs_color = ifelse(selected == TRUE, "#4DBA37", "#89EA76"))

fig <- plot_ly(county_level_sectors0, 
               x = county_level_sectors0$`County`, 
               y = county_level_sectors0$`quant_res`,
               type = "bar", 
               name = "Residential",
               marker = list(color = colors$res_color))  %>%
  add_trace(y = county_level_sectors0$`quant_nonres`,
            name = 'Non-Residential',
            marker = list(color = colors$nonres_color))  %>%
  add_trace(y = county_level_sectors0$`quant_gs`,
            name = 'Grid Supply',
            marker = list(color = colors$gs_color))  %>%
  layout(yaxis = list(title = "quantacity (MW)"), 
         xaxis = list(title = "Year",
                      tickangle = -45,
                      tickmode = 'linear', 
                      categoryorder = "total descending"),
         hovermode='x',
         barmode = "stack")
  fig}
)

```


Overall Trends
=====================================

Row
-----------------------------------------------------------------------

### Year over Year Installed Capacity Growth (2020-2021)

```{r}
renderValueBox({
  cap_yoy <- paste(prettyNum(trend_yoy[22,9],big.mark=",",digits=2))
  valueBox(cap_yoy, 
     icon = "fa-sun",
     color = "#FD8D3C")
})
```

### Year over Year Project Quantity Growth (2020-2021)

```{r}
renderValueBox({
  quant_yoy <- paste(prettyNum(trend_yoy[22,17],big.mark=",",digits=2))
  valueBox(quant_yoy,
           icon = "fa-solar-panel",
           color = "#74C476")
})
```


Row {.tabset}
-----------------------------------------------------------------------

### Cumulative Capacity Trend

```{r}
fig1 <- plot_ly(trend, x = ~Year, y = ~`Residential Capacity (Cumulative)`,
               type = 'scatter', mode = 'lines+markers', name = 'Residential') %>% 
  add_trace(y = ~`Non-Residential Capacity (Cumulative)`, name = 'Non-Residential') %>%
  add_trace(y = ~`Grid Supply Capacity (Cumulative)`, name = 'Grid Supply') %>%
  layout(yaxis = list(title = "Capacity (MW)"), 
         xaxis = list(title = "Year", tickangle = -45, tickmode = 'linear', limits=c(2000,2021)),
         hovermode='x')
fig1
```

### Yearly Capacity Growth Trend

```{r}
fig2 <- plot_ly(trend, x = ~Year, y = ~`Residential Capacity`,
               type = 'scatter', mode = 'lines+markers', name = 'Residential') %>%
  add_trace(y = ~`Non-Residential Capacity`, name = 'Non-Residential') %>%
  add_trace(y = ~`Grid Supply Capacity`, name = 'Grid Supply') %>%
  layout(yaxis = list(title = "Capacity (MW)"),
         xaxis = list(title = "Year", tickangle = -45, tickmode = 'linear'),
         hovermode='x')
fig2
```

### Cumulative Quantity Trend

```{r}
fig3 <- plot_ly(trend, x = ~Year, y = ~`Residential Quantity (Cumulative)`,
               type = 'scatter', mode = 'lines+markers', name = 'Residential') %>%
  add_trace(y = ~`Non-Residential Quantity (Cumulative)`, name = 'Non-Residential') %>%
  add_trace(y = ~`Grid Supply Quantity (Cumulative)`, name = 'Grid Supply') %>%
  layout(yaxis = list(title = "Quantity"),
         xaxis = list(title = "Year", tickangle = -45, tickmode = 'linear'),
         hovermode='x')
fig3
```

### Yearly Quantity Growth Trend

```{r}
fig4 <- plot_ly(trend, x = ~Year, y = ~`Residential Quantity`,
               type = 'scatter', mode = 'lines+markers', name = 'Residential') %>%
  add_trace(y = ~`Non-Residential Quantity`, name = 'Non-Residential') %>%
  add_trace(y = ~`Grid Supply Quantity`, name = 'Grid Supply') %>%
  layout(yaxis = list(title = "Quantity"),
         xaxis = list(title = "Year", tickangle = -45, tickmode = 'linear'),
         hovermode='x')
fig4
```

Row {.tabset}
-----------------------------------------------------------------------

### Overall

```{r}
DT::renderDataTable({
  DT::datatable(trend_trans,
                class = 'compact nowrap cell-border stripe',
                extensions = c('Responsive','Scroller','Buttons'), 
                escape = FALSE, 
                rownames = FALSE,
                options = list(bPaginate = FALSE,
                               ordering=FALSE,
                               autoWidth = TRUE,
                               scrollX=TRUE,
                               searching = FALSE,
                               buttons = c('colvis', 'excel')))
})
```

### Residential

```{r}
DT::renderDataTable({
  DT::datatable(trend_trans,
                class = 'cell-border stripe',
                extensions = 'Responsive', 
                escape = FALSE, 
                rownames = FALSE, 
                options = list(bPaginate = FALSE,
                               ordering=FALSE,
                               autoWidth = TRUE,
                               scrollX=TRUE,
  columnDefs = list(list(width = '200px', targets = "_all"),
                    list(className = 'dt-center', targets = "_all"))))
})
```


### Non-Residential

```{r}
DT::renderDataTable({
  DT::datatable(trend_trans,
                class = 'cell-border stripe',
                extensions = 'Responsive', 
                escape = FALSE, 
                rownames = FALSE, 
                options = list(bPaginate = FALSE,
                               ordering=FALSE,
                               autoWidth = TRUE,
                               scrollX=TRUE,
  columnDefs = list(list(width = '200px', targets = "_all"),
                    list(className = 'dt-center', targets = "_all"))))
})
```

### Grid Supply

```{r}
DT::renderDataTable({
  DT::datatable(trend_trans,
                class = 'cell-border stripe',
                extensions = 'Responsive', 
                escape = FALSE, 
                rownames = FALSE, 
                options = list(bPaginate = FALSE,
                               ordering=FALSE,
                               autoWidth = TRUE,
                               scrollX=TRUE,
  columnDefs = list(list(width = '200px', targets = "_all"),
                    list(className = 'dt-center', targets = "_all"))))
})
```

<<<<<<< Updated upstream
Analysis
=====================================

Row {.tabset}
-----------------------------------------------------------------------
=======

Analysis {.storyboard}
=========================================
>>>>>>> Stashed changes

Click the arrows or the boxes to learn how the solar adoption rate and third party ownership of solar is affected by different factors

### Areas with a median household income between 50k - 100k have the highest rate of solar adoption, but those with a higher income are more likely to own their solar installment. 

```{r}
fig_income <- plot_ly() %>%
  add_trace(zip_level_res, x = zip_level_res$`Income`, y = zip_level_res$`Adoption_Rate`, type = "scatter", marker = list(color = zip_level_res$`TPO_FREQ`, colorbar = list(title = "Third Party Installment Rate"), color=list("Viridis"))) %>%
  add_trace(x = income_trend$`x`, y = income_trend$`y`, mode = "lines", line = list(color = 'rgba(67,67,67,1)', width = 2)) %>%
  layout(yaxis = list(title = "Solar Adoption Rate"),
         xaxis = list(title = "Income"),
         text = list(title = "Using Zip Code Level Data"),
         showlegend = F)

fig_income
```

***

Research shows that solar adoption tends to cluster around the higher-income areas where there was early adoption of solar back in the days when it was more expensive. As solar installation prices have gone down, solar adoption hasn’t spread to lower-income households despite the tremendous benefits they would get from having cheaper utility bills [source](https://www.nature.com/articles/s41560-020-00724-2).

This chart shows that solar adoption is more popular among those areas with moderate incomes than those with higher incomes in New Jersey. Perhaps New Jersey's solar tax credits and rebates are encouraging a more equitable adoption of solar [source](https://www.sunrun.com/solar-by-state/nj/new-jersey-solar-tax-incentives). Those with moderate incomes are also probably seeking a lower utility bill rather than those who are wealthier. It also seems like those who are installing solar at low-to-moderate incomes are going more with third party installment rather than installing the solar panels themselves.

### Areas where the houses are valued lower are more likely to adopt solar and also more likely to have a third party own the solar installment.

```{r}
fig_perc_val <- plot_ly() %>%
add_trace(zip_level_res, x = zip_level_res$`House_Value`, y = zip_level_res$`Adoption_Rate`, type = "scatter", marker = list(color = zip_level_res$`TPO_FREQ`, colorbar = list(title = "Third Party Installment Rate"))) %>% 
  add_trace(x = own_trend$`x`, y = own_trend$`y`, mode = "lines", line = list(color = 'rgba(67,67,67,1)', width = 2)) %>%
  layout(yaxis = list(title = "Solar Adoption Rate"),
         xaxis = list(title = "Housing Value"),
         text = list(title = "Using Zip Code Level Data"),
         showlegend = F)

fig_perc_val
```

***

In New Jersey, homes with solar panels can sell for 9.9% more than homes without solar-energy systems which is a profit of $32,281 for the median-values home in New Jersey [source](https://www.cnbc.com/2019/10/05/solar-power-can-boost-a-homes-value-in-these-10-states-the-most.html#:~:text=In%20New%20Jersey%2C%20homes%20with,valued%20home%20in%20that%20state.). Investing in solar can also help homeowners save on energy costs.

This chart shows that homes that are valued relatively lower are adopting solar in New Jersey. Perhaps they are adopting solar to increase their housing value, while higher valued homes don't feel the need to adopt solar to increase their housing value. Home with higher values own their solar installment. 


### Areas with a higher percentage of white residents have a higher rate of solar adoption and are more likely to own their own solar installments. 


```{r}
fig_perc_white <- plot_ly() %>%
  add_trace(zip_level_res, x = zip_level_res$`Perc_White`, y = zip_level_res$`Adoption_Rate`, type = "scatter", marker = list(color = zip_level_res$`TPO_FREQ`, colorbar = list(title = "Third Party Installment Rate"))) %>% 
  add_trace(x = white_trend$`x`, y = white_trend$`y`, mode = "lines", line = list(color = 'rgba(67,67,67,1)', width = 2)) %>%
  layout(yaxis = list(title = "Solar Adoption Rate"),
         xaxis = list(title = "Percent of White Residents"),
         text = list(title = "Using Zip Code Level Data"),
         showlegend = F)

fig_perc_white

```

***

Research shows that solar adoption has been affected by language barriers [source](https://www.nature.com/articles/s41560-020-00724-2). This can affect communities with predominately minority residents that are more likely to not speak English. 

The chart support this trend since those communities with a higher percentage of white residents are adopting solar more than communities with a higher percentage of minority residents. Solar adoption is influenced by customer referrals and localized installer marketing, therefore it's likely that minorities are being left out of the conversation. 


### In areas that have a higher percentage of people who own their house rather rent, there is a higher rate of solar adoption and a higher rate of owning their own solar installment. 

```{r}
x_sort_own <- sort(zip_level_res$Perc_House_Owned)
y_sort_own <-zip_level_res$Adoption_Rate[order(zip_level_res$Perc_House_Owned)]

loess_fit_own <- loess(y_sort_own ~ x_sort_own)
rl_own <- predict(loess_fit_own)

fig_perc_house_owned <- plot_ly() %>%
  add_trace(zip_level_res, x = zip_level_res$`Perc_House_Owned`, y = zip_level_res$`Adoption_Rate`, type = "scatter", marker = list(color = zip_level_res$`TPO_FREQ`, colorbar = list(title = "Third Party Installment Rate"))) %>% 
  add_trace(x = val_trend$`x`, y = val_trend$`y`, mode = "lines", line = list(color = 'rgba(67,67,67,1)', width = 2)) %>%
  layout(yaxis = list(title = "Solar Adoption Rate"),
         xaxis = list(title = "Percent of Population That Owns Their House"),
         text = list(title = "Using Zip Code Level Data"),
         showlegend = F)

fig_perc_house_owned
```

***

A barrier to solar adoption is home ownership, and this can exclude low and moderate income families from benefiting [source](https://www.hammondclimatesolutions.com/blog/overcoming-barriers-to-solar-adoption-in-communities-of-concern). In 2018, New Jersey authorized a Community Solar Energy Pilot Program that allows residents to participate in community solar energy projects and get credit on their utility bills [source](https://earthjustice.org/news/press/2018/lawmakers-approve-bill-allowing-nj-renters-apartment-dwellers-to-access-solar-power). 

This chart shows that areas with higher home ownership rates are more likely to install solar, but projects like the Community Solar Energy Pilot Project can take a while to build - especially after COVID.