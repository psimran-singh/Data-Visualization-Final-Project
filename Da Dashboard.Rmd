---
title: "Solar Adoption in New Jersey"
output: 
  flexdashboard::flex_dashboard:
    theme: "lumen"
    orientation: rows
    source_code: "https://github.com/psimran-singh/Data-Visualization-Final-Project"
    vertical_layout: scroll
runtime: shiny

---
```{r global, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(shiny)
library(plotly)
library(formattable)
library(DT)
library(lubridate)
library(xts)
library(dygraphs)
library(nivocal)
library(sf)
library(RColorBrewer)
library(leaflet)
library(htmltools)
library(janitor)

# Load in all the necessary data tables:
setwd("~/GitHub/Data-Visualization-Final-Project/Data Files for Analysis")

## Section 1: Overall Landscape ##
load("Solar_All_County.Rda")
county_level_rates <- read_csv('County_Totals.csv')
county_level_sectors <- read_csv('County_Sectors.csv')
Solar_All_County <- st_as_sf(Solar_All_County) %>% st_transform(4326)

## Section 2: Overall Trends ## 
trend <- read_csv('Trend.csv')
trend_trans <- read_csv('Trend_Transposed.csv')
trend_yoy <- read_csv('Trend_Percents.csv')

## Section 3: Residential Landscape ##
load("Solar_Res_County.Rda")
Solar_Res_County <- st_as_sf(Solar_Res_County) %>% st_transform(4326) %>%
  mutate(CAPACITY_MW=CAPACITY/1000)
Overall_Adoption_Rate <- Solar_Res_County %>% st_drop_geometry() %>%  
  select(COUNTY,COUNT,Total_Occ_House) %>%
  adorn_totals("row") %>% filter(COUNTY=="Total") %>%
  mutate(Adoption_Rate=COUNT/Total_Occ_House)

```

Overall Landscape
=====================================

Current Landscape {.sidebar}
-----------------------------------------------------------------------

Solar energy is playing a significant role in shifting New Jersey's energy economy away from fossil fuels and towards renewables. 

This dashboard utilizes publicly available data on solar installations in New Jersey from New Jersey Board of Public Utilities' (NJBPU) Clean Energy Program. This data is current as of December 2021 and accounts for all solar installations in New Jersey.


```{r}
selectInput("County", "Select a county to highlight:", choices = distinct(county_level_rates, `County`))
```

The major sectors of solar energy are Residential, Non-Residential, and Grid Supply.

Residential solar energy consists primarily of small (~10kW) net-metered rooftop installations. Non-Residential, which covers commercial, farm, and government installations, are typically larger (~200kW) net-metered rooftop solar panel installations. Grid Supply projects, consist of very large (~6600kW) ground-mounted installations.

Row
-----------------------------------------------------------------------

### Current Installed Solar Capacity

```{r}
renderValueBox({
  total_cap <- paste(prettyNum(county_level_rates[county_level_rates$County==input$County,4],big.mark=",",digits=0)," MW")
  valueBox(total_cap, 
           icon = "fa-sun",
           color = "#FD8D3C")
})
```

### Current Installed Solar Projects

```{r}
renderValueBox({
  total_quant <- paste(prettyNum(county_level_rates[county_level_rates$County==input$County,2], big.mark=","))
  valueBox(total_quant,
           icon = "fa-solar-panel",
           color = "#74C476")
})
```

Row
-----------------------------------------------------------------------
### Total Capacity by County

```{r}
renderLeaflet(
  {Solar_All_County0 <- Solar_All_County %>%
    mutate(selected = ifelse(County == input$County, TRUE, FALSE))
    
  pal1 <- colorBin(palette = "Oranges", domain = Solar_All_County$capacity_mw)
  labs1 <- as.list(paste(Solar_All_County$County,round(Solar_All_County$capacity_mw)," MW"))
  
  map1 <- leaflet(options = leafletOptions(zoomControl = FALSE,
                                             dragging = FALSE,
                                             minZoom = 7.3,
                                             maxZoom = 7.3)) %>%
  addPolygons(data = Solar_All_County,
              label = lapply(labs1, HTML), # hover label
              color = "grey", # the color of the border
              fillColor = ~pal1(Solar_All_County$capacity_mw), # the colors inside the polygons
              weight = 1.0, # the thickness of the border lines
              opacity = 1.0, # the transparency of the border lines
              fillOpacity = 1.0) %>%
  addLegend(data = Solar_All_County, # the dataset
            "bottomright", # where to put the legend
            pal = pal1, values = ~capacity_mw, # specify the color palette and the range of values 
            title = "Capacity (MW)", # legend title
            opacity = 1.0) 
  # %>%
  # addPolygons(data = Solar_All_County0[Solar_All_County0$selected==TRUE],
  #             color="yellow",
  #             weight=1.5,
  #             fillOpacity=0)

    map1}
)
```

### Total Quantity by County

```{r}
renderLeaflet(
  {pal2 <- colorBin(palette = "Greens", domain = Solar_All_County$quantity, 6)
  labs2 <- as.list(paste(Solar_All_County$County,
                         prettyNum(Solar_All_County$quantity,big.mark=",",digits=1)))
  
  
  map2 <- leaflet(options = leafletOptions(zoomControl = FALSE,
                                             dragging = FALSE,
                                             minZoom = 7.3,
                                             maxZoom = 7.3)) %>%
  addPolygons(data = Solar_All_County,
              label = lapply(labs2,HTML), # hover label
              color = "grey", # the color of the border
              fillColor = ~pal2(Solar_All_County$quantity), # the colors inside the polygons
              weight = 1.0, # the thickness of the border lines
              opacity = 1.0, # the transparency of the border lines
              fillOpacity = 1.0) %>%
  addLegend(data = Solar_All_County, # the dataset
            "bottomright", # where to put the legend
            pal = pal2, values = ~quantity, # specify the color palette and the range of values 
            title = "# of Projects", # legend title
            opacity = 1.0) # the transparency of the legend

    map2}
)
```

Row {.tabset}
-----------------------------------------------------------------------

### Capacity by County and Sector

```{r}
renderPlotly(
  {county_level_sectors0 <- county_level_sectors %>% filter(County != "Overall") %>%
    mutate(selected = ifelse(County == input$County, TRUE, FALSE))
  
  colors <- county_level_sectors0 %>% select(County,selected) %>% 
    mutate(res_color = ifelse(selected == TRUE, "#6367CE", "#9FA3F2")) %>%
    mutate(nonres_color = ifelse(selected == TRUE, "#F1A73E", "#F7C57D")) %>%
    mutate(gs_color = ifelse(selected == TRUE, "#4DBA37", "#89EA76"))

fig <- plot_ly(county_level_sectors0, 
               x = county_level_sectors0$`County`, 
               y = (county_level_sectors0$`cap_res`/1000),
               type = "bar", 
               name = "Residential",
               marker = list(color = colors$res_color))  %>%
  add_trace(y = (county_level_sectors0$`cap_nonres`/1000),
            name = 'Non-Residential',
            marker = list(color = colors$nonres_color))  %>%
  add_trace(y = (county_level_sectors0$`cap_gs`/1000),
            name = 'Grid Supply',
            marker = list(color = colors$gs_color))  %>%
  layout(yaxis = list(title = "Capacity (MW)"), 
         xaxis = list(title = "Year",
                      tickangle = -45,
                      tickmode = 'linear', 
                      categoryorder = "total descending"),
         hovermode='x',
         barmode = "stack")
  fig}
)

```

### Quantity by County and Sector

```{r}
renderPlotly(
  {county_level_sectors0 <- county_level_sectors %>% filter(County != "Overall") %>%
    mutate(selected = ifelse(County == input$County, TRUE, FALSE))
  
  colors <- county_level_sectors0 %>% select(County,selected) %>% 
    mutate(res_color = ifelse(selected == TRUE, "#6367CE", "#9FA3F2")) %>%
    mutate(nonres_color = ifelse(selected == TRUE, "#F1A73E", "#F7C57D")) %>%
    mutate(gs_color = ifelse(selected == TRUE, "#4DBA37", "#89EA76"))

fig <- plot_ly(county_level_sectors0, 
               x = county_level_sectors0$`County`, 
               y = county_level_sectors0$`quant_res`,
               type = "bar", 
               name = "Residential",
               marker = list(color = colors$res_color))  %>%
  add_trace(y = county_level_sectors0$`quant_nonres`,
            name = 'Non-Residential',
            marker = list(color = colors$nonres_color))  %>%
  add_trace(y = county_level_sectors0$`quant_gs`,
            name = 'Grid Supply',
            marker = list(color = colors$gs_color))  %>%
  layout(yaxis = list(title = "quantacity (MW)"), 
         xaxis = list(title = "Year",
                      tickangle = -45,
                      tickmode = 'linear', 
                      categoryorder = "total descending"),
         hovermode='x',
         barmode = "stack")
  fig}
)

```


Overall Trends
=====================================

Row
-----------------------------------------------------------------------

### Year over Year Installed Capacity Growth (2020-2021)

```{r}
renderValueBox({
  cap_yoy <- paste(prettyNum(trend_yoy[22,9],big.mark=",",digits=2))
  valueBox(cap_yoy, 
     icon = "fa-sun",
     color = "#FD8D3C")
})
```

### Year over Year Project Quantity Growth (2020-2021)

```{r}
renderValueBox({
  quant_yoy <- paste(prettyNum(trend_yoy[22,17],big.mark=",",digits=2))
  valueBox(quant_yoy,
           icon = "fa-solar-panel",
           color = "#74C476")
})
```


Row {.tabset}
-----------------------------------------------------------------------

### Cumulative Capacity Trend

```{r}
fig1 <- plot_ly(trend, x = ~Year, y = ~`Residential Capacity (Cumulative)`,
               type = 'scatter', mode = 'lines+markers', name = 'Residential') %>% 
  add_trace(y = ~`Non-Residential Capacity (Cumulative)`, name = 'Non-Residential') %>%
  add_trace(y = ~`Grid Supply Capacity (Cumulative)`, name = 'Grid Supply') %>%
  layout(yaxis = list(title = "Capacity (MW)"), 
         xaxis = list(title = "Year", tickangle = -45, tickmode = 'linear', limits=c(2000,2021)),
         hovermode='x')
fig1
```

### Yearly Capacity Growth Trend

```{r}
fig2 <- plot_ly(trend, x = ~Year, y = ~`Residential Capacity`,
               type = 'scatter', mode = 'lines+markers', name = 'Residential') %>%
  add_trace(y = ~`Non-Residential Capacity`, name = 'Non-Residential') %>%
  add_trace(y = ~`Grid Supply Capacity`, name = 'Grid Supply') %>%
  layout(yaxis = list(title = "Capacity (MW)"),
         xaxis = list(title = "Year", tickangle = -45, tickmode = 'linear'),
         hovermode='x')
fig2
```

### Cumulative Quantity Trend

```{r}
fig3 <- plot_ly(trend, x = ~Year, y = ~`Residential Quantity (Cumulative)`,
               type = 'scatter', mode = 'lines+markers', name = 'Residential') %>%
  add_trace(y = ~`Non-Residential Quantity (Cumulative)`, name = 'Non-Residential') %>%
  add_trace(y = ~`Grid Supply Quantity (Cumulative)`, name = 'Grid Supply') %>%
  layout(yaxis = list(title = "Quantity"),
         xaxis = list(title = "Year", tickangle = -45, tickmode = 'linear'),
         hovermode='x')
fig3
```

### Yearly Quantity Growth Trend

```{r}
fig4 <- plot_ly(trend, x = ~Year, y = ~`Residential Quantity`,
               type = 'scatter', mode = 'lines+markers', name = 'Residential') %>%
  add_trace(y = ~`Non-Residential Quantity`, name = 'Non-Residential') %>%
  add_trace(y = ~`Grid Supply Quantity`, name = 'Grid Supply') %>%
  layout(yaxis = list(title = "Quantity"),
         xaxis = list(title = "Year", tickangle = -45, tickmode = 'linear'),
         hovermode='x')
fig4
```

Row {.tabset}
-----------------------------------------------------------------------

### Overall

```{r}
DT::renderDataTable({
  DT::datatable(trend_trans,
                class = 'compact nowrap cell-border stripe',
                extensions = c('Responsive','Scroller','Buttons'), 
                escape = FALSE, 
                rownames = FALSE,
                options = list(bPaginate = FALSE,
                               ordering=FALSE,
                               autoWidth = TRUE,
                               scrollX=TRUE,
                               searching = FALSE,
                               buttons = c('colvis', 'excel')))
})
```

### Residential

```{r}
DT::renderDataTable({
  DT::datatable(trend_trans,
                class = 'cell-border stripe',
                extensions = 'Responsive', 
                escape = FALSE, 
                rownames = FALSE, 
                options = list(bPaginate = FALSE,
                               ordering=FALSE,
                               autoWidth = TRUE,
                               scrollX=TRUE,
  columnDefs = list(list(width = '200px', targets = "_all"),
                    list(className = 'dt-center', targets = "_all"))))
})
```


### Non-Residential

```{r}
DT::renderDataTable({
  DT::datatable(trend_trans,
                class = 'cell-border stripe',
                extensions = 'Responsive', 
                escape = FALSE, 
                rownames = FALSE, 
                options = list(bPaginate = FALSE,
                               ordering=FALSE,
                               autoWidth = TRUE,
                               scrollX=TRUE,
  columnDefs = list(list(width = '200px', targets = "_all"),
                    list(className = 'dt-center', targets = "_all"))))
})
```

### Grid Supply

```{r}
DT::renderDataTable({
  DT::datatable(trend_trans,
                class = 'cell-border stripe',
                extensions = 'Responsive', 
                escape = FALSE, 
                rownames = FALSE, 
                options = list(bPaginate = FALSE,
                               ordering=FALSE,
                               autoWidth = TRUE,
                               scrollX=TRUE,
  columnDefs = list(list(width = '200px', targets = "_all"),
                    list(className = 'dt-center', targets = "_all"))))
})
```


Residential Landscape
=====================================

Row
-----------------------------------------------------------------------

### Current Installed Residential Rooftop Solar Capacity

```{r}
renderValueBox({
  total_cap <- paste(prettyNum(county_level_sectors[county_level_sectors$County=="Overall",3]/1000,
                               big.mark=",",digits=0)," MW")
  valueBox(total_cap, 
           icon = "fa-sun",
           color = "#FD8D3C")
})
```

### Current Installed Residential Rooftop Solar Projects

```{r}
renderValueBox({
  total_quant <- paste(prettyNum(county_level_sectors[county_level_sectors$County=="Overall",2], big.mark=","))
  valueBox(total_quant,
           icon = "fa-solar-panel",
           color = "#74C476")
})
```

### Current Residential Rooftop Adoption Rate

```{r}
renderValueBox({
  total_rate <- paste(prettyNum(Overall_Adoption_Rate[1,4], big.mark=","))
  valueBox(total_rate,
           icon = "fa-house-user",
           color = "#6baed6")
})
```


Row 
-----------------------------------------------------------------------

### Total Residential Rooftop Capacity by County

```{r}
pal3 <- colorBin(palette = "Oranges", domain = Solar_Res_County$CAPACITY_MW)
labs3 <- as.list(paste(Solar_Res_County$COUNTY,round(Solar_Res_County$CAPACITY_MW)," MW"))
  
map3 <- leaflet(options = leafletOptions(zoomControl = FALSE,
                                             dragging = FALSE,
                                             minZoom = 7.3,
                                             maxZoom = 7.3)) %>%
addPolygons(data = Solar_Res_County,
              label = lapply(labs3, HTML), # hover label
              color = "grey", # the color of the border
              fillColor = ~pal3(Solar_Res_County$CAPACITY_MW), # the colors inside the polygons
              weight = 1.0, # the thickness of the border lines
              opacity = 1.0, # the transparency of the border lines
              fillOpacity = 1.0) %>%
addLegend(data = Solar_Res_County, # the dataset
            "bottomright", # where to put the legend
            pal = pal3, values = ~CAPACITY_MW, # specify the color palette and the range of values 
            title = "Capacity (MW)", # legend title
            opacity = 1.0) 

map3

```

### Total Residential Rooftop Quantity by County

```{r}
pal4 <- colorBin(palette = "Greens", domain = Solar_Res_County$COUNT, 6)
labs4 <- as.list(paste(Solar_Res_County$COUNTY,
                         prettyNum(Solar_Res_County$COUNT,big.mark=",",digits=1)))
  
map4 <- leaflet(options = leafletOptions(zoomControl = FALSE,
                                             dragging = FALSE,
                                             minZoom = 7.3,
                                             maxZoom = 7.3)) %>%
addPolygons(data = Solar_Res_County,
              label = lapply(labs4, HTML), # hover label
              color = "grey", # the color of the border
              fillColor = ~pal4(Solar_Res_County$COUNT), # the colors inside the polygons
              weight = 1.0, # the thickness of the border lines
              opacity = 1.0, # the transparency of the border lines
              fillOpacity = 1.0) %>%
addLegend(data = Solar_Res_County, # the dataset
            "bottomright", # where to put the legend
            pal = pal4, values = ~COUNT, # specify the color palette and the range of values 
            title = "Quantity", # legend title
            opacity = 1.0) 

map4

```

### Residential Rooftop Solar Adoption Rate by County

```{r}
pal5 <- colorBin(palette = "Blues", domain = Solar_Res_County$Adoption_Rate, 6)
labs5 <- as.list(paste(Solar_Res_County$COUNTY,
                         prettyNum(100*Solar_Res_County$Adoption_Rate,big.mark=",",digits=3)," %"))
  
map5 <- leaflet(options = leafletOptions(zoomControl = FALSE,
                                             dragging = FALSE,
                                             minZoom = 7.3,
                                             maxZoom = 7.3)) %>%
addPolygons(data = Solar_Res_County,
              label = lapply(labs5, HTML), # hover label
              color = "grey", # the color of the border
              fillColor = ~pal5(Solar_Res_County$Adoption_Rate), # the colors inside the polygons
              weight = 1.0, # the thickness of the border lines
              opacity = 1.0, # the transparency of the border lines
              fillOpacity = 1.0) %>%
addLegend(data = Solar_Res_County, # the dataset
            "bottomright", # where to put the legend
            pal = pal5, values = ~Adoption_Rate, # specify the color palette and the range of values
            title = "Adoption Rate", # legend title
            opacity = 1.0) 

map5

```
